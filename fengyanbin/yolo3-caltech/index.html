<!DOCTYPE HTML>
<html lang="zh-CN">



<head>
    <meta charset="utf-8">
    <meta name="keywords" content="全网最详细Yolov3训练Caltech Pedestrain数据集并绘制fppi miss rate图, 孙孟鑫,sunmengxin,mengxin,孟鑫,机电一体化,机器人">
    <meta name="baidu-site-verification" content="wGFMStAFna" />
    <meta name="google-site-verification" content="aSdRqh383jhnQe6RPmd5mkt5UZMXUC1Z_tNs2cLpsyE" />
    <meta name="360-site-verification" content="" />
    <meta name="description" content="Yolov3训练Caltech Pedestrain数据集">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>全网最详细Yolov3训练Caltech Pedestrain数据集并绘制fppi miss rate图 | MengXin</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

    
    

<meta name="generator" content="Hexo 4.1.1"><link rel="alternate" href="/atom.xml" title="MengXin" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">MengXin</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">MengXin</div>
        <div class="logo-desc">
            
            中南大学 | 机械工程 | 机器人
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
				<i class="fas fa-fw fa-link"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
				<i class="fas fa-fw fa-link"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
				<i class="fas fa-fw fa-link"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
				<i class="fas fa-fw fa-link"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
				<i class="fas fa-fw fa-link"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
				<i class="fas fa-fw fa-link"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
				<i class="fas fa-fw fa-link"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/MM-X" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/MM-X" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://i.loli.net/2020/11/09/WL4aG6UAZIKwDd5.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">全网最详细Yolov3训练Caltech Pedestrain数据集并绘制fppi miss rate图</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E8%A7%86%E8%A7%89/">
                                <span class="chip bg-color">视觉</span>
                            </a>
                        
                            <a href="/tags/Yolov3/">
                                <span class="chip bg-color">Yolov3</span>
                            </a>
                        
                            <a href="/tags/Caltech/">
                                <span class="chip bg-color">Caltech</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%A7%86%E8%A7%89/" class="post-category">
                                视觉
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-11-09
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    7.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    35 分
                </div>
                
				
                
                    <span id="busuanzi_container_page_pv" style='display:none'></span>
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </span>
				
            </div>
            
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p><strong>本帖来自于<a href="https://blog.csdn.net/fatterrier" target="_blank" rel="noopener">Shadow丶dream</a>大佬，欢迎关注。</strong> 原帖<a href="https://blog.csdn.net/fatterrier/article/details/109559083" target="_blank" rel="noopener">https://blog.csdn.net/fatterrier/article/details/109559083</a></p>
<h3 id="1-环境要求"><a href="#1-环境要求" class="headerlink" title="1.环境要求"></a>1.环境要求</h3><p>1.<strong>python3</strong>，网上很多代码是python2版本的，我大概修改了一下，<strong>所有代码都只适用于python3版本。</strong></p>
<p>2.<strong>matlab</strong> ，这是因为matlab提供了这个画图的函数，所以画图必须要用到matlab。</p>
<p>3.<strong>AlexeyAB</strong> 版本的yolo，本文基于的是这个版本。因为图片数量巨大，在ubuntu打开对应文件夹时会很卡，所以将caltech转换为yolo格式时我是在windows下处理的。训练的时候我是在ubuntu训练的（因为环境配置简单很多）。但是代码对系统没有要求，哪个系统都可以。</p>
<p>4.路径如果跟我设置成一样的基本不用修改代码，否则在代码中修改成自己的路径即可。</p>
<h3 id="2-caltech数据集做成VOC格式"><a href="#2-caltech数据集做成VOC格式" class="headerlink" title="2.caltech数据集做成VOC格式"></a>2.caltech数据集做成VOC格式</h3><p>​        这一部分内容参考自<a href="https://github.com/shadowwalker00/CaltechPestrain2VOC。" target="_blank" rel="noopener">https://github.com/shadowwalker00/CaltechPestrain2VOC。</a></p>
<h4 id="2-1官网下载数据集"><a href="#2-1官网下载数据集" class="headerlink" title="2.1官网下载数据集"></a>2.1官网下载数据集</h4><p>​        在官网<a href="https://drive.google.com/drive/folders/1IBlcJP8YsCaT81LwQ2YwQJac8bf1q8xF上将所有文件下载下来，建议搭梯子，会快很多。其中annotations是标注文件，下载下来格式为vbb，后续转换为xml格式；set00-set10包含是图像，格式是seq，后续转换为jpg。" target="_blank" rel="noopener">https://drive.google.com/drive/folders/1IBlcJP8YsCaT81LwQ2YwQJac8bf1q8xF上将所有文件下载下来，建议搭梯子，会快很多。其中annotations是标注文件，下载下来格式为vbb，后续转换为xml格式；set00-set10包含是图像，格式是seq，后续转换为jpg。</a></p>
<h4 id="2-2将seq格式文件转换为jpg图片"><a href="#2-2将seq格式文件转换为jpg图片" class="headerlink" title="2.2将seq格式文件转换为jpg图片"></a>2.2将seq格式文件转换为jpg图片</h4><p>​        调用<strong>seq2jpg_py3.py</strong>文件进行转换，只需在代码<strong>41行和42行</strong>修改输入输出路径即可。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#coding=utf-8</span>
<span class="token comment" spellcheck="true"># Deal with .seq format for video sequence</span>
<span class="token comment" spellcheck="true"># Author: Kaij</span>
<span class="token comment" spellcheck="true"># The .seq file is combined with images,</span>
<span class="token comment" spellcheck="true"># so I split the file into several images with the image prefix</span>
<span class="token comment" spellcheck="true"># "\xFF\xD8\xFF\xE0\x00\x10\x4A\x46\x49\x46".</span>

<span class="token keyword">import</span> os<span class="token punctuation">.</span>path
<span class="token keyword">import</span> fnmatch
<span class="token keyword">import</span> shutil

<span class="token keyword">def</span> <span class="token function">open_save</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span>savepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># read .seq file, and save the images into the savepath</span>

    f <span class="token operator">=</span> open<span class="token punctuation">(</span>file<span class="token punctuation">,</span><span class="token string">'rb+'</span><span class="token punctuation">)</span>
    string <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'latin-1'</span><span class="token punctuation">)</span>
    splitstring <span class="token operator">=</span> <span class="token string">"\xFF\xD8\xFF\xE0\x00\x10\x4A\x46\x49\x46"</span>
    <span class="token comment" spellcheck="true"># split .seq file into segment with the image prefix</span>
    strlist<span class="token operator">=</span>string<span class="token punctuation">.</span>split<span class="token punctuation">(</span>splitstring<span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment" spellcheck="true"># delete the image folder path if it exists</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>savepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        shutil<span class="token punctuation">.</span>rmtree<span class="token punctuation">(</span>savepath<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># create the image folder path</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>savepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>savepath<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># deal with file segment, every segment is an image except the first one</span>
    <span class="token keyword">for</span> img <span class="token keyword">in</span> strlist<span class="token punctuation">:</span>
        filename <span class="token operator">=</span> str<span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'.jpg'</span>
        filenamewithpath<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>savepath<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># abandon the first one, which is filled with .seq header</span>
        <span class="token keyword">if</span> count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            i<span class="token operator">=</span>open<span class="token punctuation">(</span>filenamewithpath<span class="token punctuation">,</span><span class="token string">'wb+'</span><span class="token punctuation">)</span>
            i<span class="token punctuation">.</span>write<span class="token punctuation">(</span>splitstring<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'latin-1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            i<span class="token punctuation">.</span>write<span class="token punctuation">(</span>img<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'latin-1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            i<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        count <span class="token operator">+=</span> <span class="token number">1</span>

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    rootdir <span class="token operator">=</span> <span class="token string">"D:\data set\caltech"</span>
    saveroot <span class="token operator">=</span> <span class="token string">"D:/data set/caltech/VOCdevkit/JPEG"</span>
    <span class="token comment" spellcheck="true"># walk in the rootdir, take down the .seq filename and filepath</span>
    <span class="token keyword">for</span> parent<span class="token punctuation">,</span> dirnames<span class="token punctuation">,</span> filenames <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>rootdir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> filename <span class="token keyword">in</span> filenames<span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># check .seq file with suffix</span>
            <span class="token keyword">if</span> fnmatch<span class="token punctuation">.</span>fnmatch<span class="token punctuation">(</span>filename<span class="token punctuation">,</span><span class="token string">'*.seq'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment" spellcheck="true"># take down the filename with path of .seq file</span>
                thefilename <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>parent<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true"># create the image folder by combining .seq file path with .seq filename</span>
                thesavepath <span class="token operator">=</span> saveroot <span class="token operator">+</span><span class="token string">'\\'</span><span class="token operator">+</span> parent<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\\'</span> <span class="token operator">+</span> filename<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'\\'</span>
                <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"Filename="</span> <span class="token operator">+</span> thefilename<span class="token punctuation">)</span>
                <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"Savepath="</span> <span class="token operator">+</span> thesavepath<span class="token punctuation">)</span>
                open_save<span class="token punctuation">(</span>thefilename<span class="token punctuation">,</span>thesavepath<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出目录如下图所示：</p>
<img width="600" src="https://i.loli.net/2020/11/09/khgybluEPWX1KH6.png">

<img width="600" src="https://i.loli.net/2020/11/09/5f8qZVMk3RKUwBn.png">

<img width="600" src="https://i.loli.net/2020/11/09/ABoCdDgNWehli95.png">

<h4 id="2-3将vbb格式转换为xml格式"><a href="#2-3将vbb格式转换为xml格式" class="headerlink" title="2.3将vbb格式转换为xml格式"></a>2.3将vbb格式转换为xml格式</h4><p>​    调用<strong>vbb2voc.py</strong>文件，只需修改代码<strong>161和162行</strong>的输入和输出目录即可。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token keyword">import</span> os<span class="token punctuation">,</span> glob
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>io <span class="token keyword">import</span> loadmat
<span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree<span class="token punctuation">,</span> objectify

<span class="token keyword">def</span> <span class="token function">vbb_anno2dict</span><span class="token punctuation">(</span>vbb_file<span class="token punctuation">,</span> cam_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">#通过os.path.basename获得路径的最后部分“文件名.扩展名”</span>
    <span class="token comment" spellcheck="true">#通过os.path.splitext获得文件名</span>
    filename <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>vbb_file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true">#定义字典对象annos</span>
    annos <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>dict<span class="token punctuation">)</span>
    vbb <span class="token operator">=</span> loadmat<span class="token punctuation">(</span>vbb_file<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># object info in each frame: id, pos, occlusion, lock, posv</span>
    objLists <span class="token operator">=</span> vbb<span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    objLbl <span class="token operator">=</span> <span class="token punctuation">[</span>str<span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> v <span class="token keyword">in</span> vbb<span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>     <span class="token comment" spellcheck="true">#可查看所有类别        </span>
    <span class="token comment" spellcheck="true"># person index</span>
    person_index_list <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>objLbl<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"person"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>   <span class="token comment" spellcheck="true">#只选取类别为‘person’的xml</span>
    <span class="token keyword">for</span> frame_id<span class="token punctuation">,</span> obj <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>objLists<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> len<span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            frame_name <span class="token operator">=</span> str<span class="token punctuation">(</span>cam_id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>frame_id<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".jpg"</span>
            annos<span class="token punctuation">[</span>frame_name<span class="token punctuation">]</span> <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>list<span class="token punctuation">)</span>
            annos<span class="token punctuation">[</span>frame_name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> frame_name
            annos<span class="token punctuation">[</span>frame_name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"person"</span>
            <span class="token keyword">for</span> id<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> occl <span class="token keyword">in</span> zip<span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> obj<span class="token punctuation">[</span><span class="token string">'pos'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> obj<span class="token punctuation">[</span><span class="token string">'occl'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                id <span class="token operator">=</span> int<span class="token punctuation">(</span>id<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>  <span class="token comment" spellcheck="true"># for matlab start from 1 not 0</span>
                <span class="token keyword">if</span> <span class="token operator">not</span> id <span class="token keyword">in</span> person_index_list<span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># only use bbox whose label is person</span>
                    <span class="token keyword">continue</span>
                pos <span class="token operator">=</span> pos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
                occl <span class="token operator">=</span> int<span class="token punctuation">(</span>occl<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                annos<span class="token punctuation">[</span>frame_name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"occlusion"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>occl<span class="token punctuation">)</span>
                annos<span class="token punctuation">[</span>frame_name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"bbox"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>pos<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token operator">not</span> annos<span class="token punctuation">[</span>frame_name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"bbox"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">del</span> annos<span class="token punctuation">[</span>frame_name<span class="token punctuation">]</span>
    <span class="token keyword">print</span> <span class="token punctuation">(</span>annos<span class="token punctuation">)</span>
    <span class="token keyword">return</span> annos


<span class="token keyword">def</span> <span class="token function">seq2img</span><span class="token punctuation">(</span>annos<span class="token punctuation">,</span> seq_file<span class="token punctuation">,</span> outdir<span class="token punctuation">,</span> cam_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>seq_file<span class="token punctuation">)</span>
    index <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token comment" spellcheck="true"># captured frame list</span>
    v_id <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>seq_file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    cap_frames_index <span class="token operator">=</span> np<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">[</span>int<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> id <span class="token keyword">in</span> annos<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ret<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token operator">not</span> index <span class="token keyword">in</span> cap_frames_index<span class="token punctuation">:</span>
                index <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>outdir<span class="token punctuation">)</span><span class="token punctuation">:</span>
                os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>outdir<span class="token punctuation">)</span>
            outname <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>outdir<span class="token punctuation">,</span> str<span class="token punctuation">(</span>cam_id<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"_"</span><span class="token operator">+</span>v_id<span class="token operator">+</span><span class="token string">"_"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">".jpg"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"Current frame: "</span><span class="token punctuation">,</span> v_id<span class="token punctuation">,</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>outname<span class="token punctuation">,</span> frame<span class="token punctuation">)</span>
            height<span class="token punctuation">,</span> width<span class="token punctuation">,</span> _ <span class="token operator">=</span> frame<span class="token punctuation">.</span>shape
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        index <span class="token operator">+=</span> <span class="token number">1</span>
    img_size <span class="token operator">=</span> <span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img_size


<span class="token keyword">def</span> <span class="token function">instance2xml_base</span><span class="token punctuation">(</span>anno<span class="token punctuation">,</span> bbox_type<span class="token operator">=</span><span class="token string">'xyxy'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""bbox_type: xyxy (xmin, ymin, xmax, ymax); xywh (xmin, ymin, width, height)"""</span>
    <span class="token keyword">assert</span> bbox_type <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'xyxy'</span><span class="token punctuation">,</span> <span class="token string">'xywh'</span><span class="token punctuation">]</span>
    E <span class="token operator">=</span> objectify<span class="token punctuation">.</span>ElementMaker<span class="token punctuation">(</span>annotate<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    anno_tree <span class="token operator">=</span> E<span class="token punctuation">.</span>annotation<span class="token punctuation">(</span>
        E<span class="token punctuation">.</span>folder<span class="token punctuation">(</span><span class="token string">'VOC2014_instance/person'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        E<span class="token punctuation">.</span>filename<span class="token punctuation">(</span>anno<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        E<span class="token punctuation">.</span>source<span class="token punctuation">(</span>
            E<span class="token punctuation">.</span>database<span class="token punctuation">(</span><span class="token string">'Caltech pedestrian'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            E<span class="token punctuation">.</span>annotation<span class="token punctuation">(</span><span class="token string">'Caltech pedestrian'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            E<span class="token punctuation">.</span>image<span class="token punctuation">(</span><span class="token string">'Caltech pedestrian'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            E<span class="token punctuation">.</span>url<span class="token punctuation">(</span><span class="token string">'None'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        E<span class="token punctuation">.</span>size<span class="token punctuation">(</span>
            E<span class="token punctuation">.</span>width<span class="token punctuation">(</span><span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            E<span class="token punctuation">.</span>height<span class="token punctuation">(</span><span class="token number">480</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            E<span class="token punctuation">.</span>depth<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        E<span class="token punctuation">.</span>segmented<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">for</span> index<span class="token punctuation">,</span> bbox <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>anno<span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        bbox <span class="token operator">=</span> <span class="token punctuation">[</span>float<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> bbox<span class="token punctuation">]</span>
        <span class="token keyword">if</span> bbox_type <span class="token operator">==</span> <span class="token string">'xyxy'</span><span class="token punctuation">:</span>
            xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> bbox
            xmax <span class="token operator">=</span> xmin<span class="token operator">+</span>w
            ymax <span class="token operator">=</span> ymin<span class="token operator">+</span>h
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> ymax <span class="token operator">=</span> bbox
        E <span class="token operator">=</span> objectify<span class="token punctuation">.</span>ElementMaker<span class="token punctuation">(</span>annotate<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        anno_tree<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
            E<span class="token punctuation">.</span>object<span class="token punctuation">(</span>
            E<span class="token punctuation">.</span>name<span class="token punctuation">(</span>anno<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            E<span class="token punctuation">.</span>bndbox<span class="token punctuation">(</span>
                E<span class="token punctuation">.</span>xmin<span class="token punctuation">(</span>xmin<span class="token punctuation">)</span><span class="token punctuation">,</span>
                E<span class="token punctuation">.</span>ymin<span class="token punctuation">(</span>ymin<span class="token punctuation">)</span><span class="token punctuation">,</span>
                E<span class="token punctuation">.</span>xmax<span class="token punctuation">(</span>xmax<span class="token punctuation">)</span><span class="token punctuation">,</span>
                E<span class="token punctuation">.</span>ymax<span class="token punctuation">(</span>ymax<span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            E<span class="token punctuation">.</span>difficult<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            E<span class="token punctuation">.</span>occlusion<span class="token punctuation">(</span>anno<span class="token punctuation">[</span><span class="token string">"occlusion"</span><span class="token punctuation">]</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">return</span> anno_tree


<span class="token keyword">def</span> <span class="token function">parse_anno_file</span><span class="token punctuation">(</span>vbb_inputdir<span class="token punctuation">,</span>vbb_outputdir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># annotation sub-directories in hda annotation input directory</span>
    <span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>vbb_inputdir<span class="token punctuation">)</span>
    sub_dirs <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>vbb_inputdir<span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">#对应set00,set01...</span>
    <span class="token keyword">for</span> sub_dir <span class="token keyword">in</span> sub_dirs<span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"Parsing annotations of camera: "</span><span class="token punctuation">,</span> sub_dir<span class="token punctuation">)</span>
        cam_id <span class="token operator">=</span> sub_dir
        <span class="token comment" spellcheck="true">#获取某一个子set下面的所有vbb文件</span>
        vbb_files <span class="token operator">=</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>vbb_inputdir<span class="token punctuation">,</span> sub_dir<span class="token punctuation">,</span> <span class="token string">"*.vbb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">for</span> vbb_file <span class="token keyword">in</span> vbb_files<span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true">#返回一个vbb文件中所有的帧的标注结果</span>
            annos <span class="token operator">=</span> vbb_anno2dict<span class="token punctuation">(</span>vbb_file<span class="token punctuation">,</span> cam_id<span class="token punctuation">)</span>

            <span class="token keyword">if</span> annos<span class="token punctuation">:</span>
                <span class="token comment" spellcheck="true">#组成xml文件的存储文件夹，形如“/Users/chenguanghao/Desktop/Caltech/xmlresult/”</span>
                vbb_outdir <span class="token operator">=</span> vbb_outputdir

                <span class="token comment" spellcheck="true">#如果不存在</span>
                <span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>vbb_outdir<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>vbb_outdir<span class="token punctuation">)</span>

                <span class="token keyword">for</span> filename<span class="token punctuation">,</span> anno <span class="token keyword">in</span> sorted<span class="token punctuation">(</span>annos<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                  
                    <span class="token keyword">if</span> <span class="token string">"bbox"</span> <span class="token keyword">in</span> anno<span class="token punctuation">:</span>
                        anno_tree <span class="token operator">=</span> instance2xml_base<span class="token punctuation">(</span>anno<span class="token punctuation">)</span>
                        outfile <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>vbb_outdir<span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">".xml"</span><span class="token punctuation">)</span>
                        <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"Generating annotation xml file of picture: "</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">#生成最终的xml文件，对应一张图片</span>
                        etree<span class="token punctuation">.</span>ElementTree<span class="token punctuation">(</span>anno_tree<span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>outfile<span class="token punctuation">,</span> pretty_print<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>            
<span class="token keyword">def</span> <span class="token function">visualize_bbox</span><span class="token punctuation">(</span>xml_file<span class="token punctuation">,</span> img_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> cv2
    tree <span class="token operator">=</span> etree<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>xml_file<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># load image</span>
    image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_file<span class="token punctuation">)</span>
    origin <span class="token operator">=</span>  cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_file<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 获取一张图片的所有bbox</span>
    <span class="token keyword">for</span> bbox <span class="token keyword">in</span> tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//bndbox'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        coord <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> corner <span class="token keyword">in</span> bbox<span class="token punctuation">.</span>getchildren<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            coord<span class="token punctuation">.</span>append<span class="token punctuation">(</span>int<span class="token punctuation">(</span>float<span class="token punctuation">(</span>corner<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span>coord<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token punctuation">(</span>coord<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> coord<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>coord<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> coord<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># visualize image</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'origin'</span><span class="token punctuation">,</span>origin<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    vbb_inputdir <span class="token operator">=</span> <span class="token string">"D:/data set/caltech/annotations"</span>
    vbb_outputdir <span class="token operator">=</span> <span class="token string">"D:/data set/caltech/VOCdevkit/annotations"</span>
    parse_anno_file<span class="token punctuation">(</span>vbb_inputdir<span class="token punctuation">,</span>vbb_outputdir<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​        输出目录在VOCdevkit/annotations下，总共生成<strong>122187</strong>个xml文件，且全部放在了一起。第一个文件名是 set00_V000_69.xml，这是因为并不是每一张图片都有行人，只有含有行人的图片才被标注。这里细心的小伙伴可能发现在set00_V000_69.jpg图片里找不到人，其实是因为caltech数据集行人太小，分辨率过低的缘故。图中人在天桥上特别小，可以用opencv画矩形框在图上就可以发现。这里给出一个在图片上批量标注矩形框的代码。此处需要安装opencv。代码主要修改<strong>第11行</strong>的输入图片路径、<strong>12行</strong>的输入xml路径、28行的输出图片路径和<strong>30行</strong>的输入路径。运行完可以查看一下标注图片，发现确实有人。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#coding=tuf-8</span>
<span class="token keyword">import</span> xml<span class="token punctuation">.</span>etree<span class="token punctuation">.</span>ElementTree <span class="token keyword">as</span> ET
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> os
<span class="token keyword">from</span> os <span class="token keyword">import</span> listdir<span class="token punctuation">,</span> getcwd
<span class="token keyword">from</span> os<span class="token punctuation">.</span>path <span class="token keyword">import</span> join
<span class="token keyword">import</span> cv2

<span class="token keyword">def</span> <span class="token function">convert_annotation</span><span class="token punctuation">(</span>setxxx<span class="token punctuation">,</span>vxxx<span class="token punctuation">,</span>xxxjpg<span class="token punctuation">)</span><span class="token punctuation">:</span>

    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"D:\data set\caltech\VOCdevkit\JPEG\set%s\V%s\%s.jpg"</span><span class="token operator">%</span><span class="token punctuation">(</span>setxxx<span class="token punctuation">,</span>vxxx<span class="token punctuation">,</span>xxxjpg<span class="token punctuation">)</span><span class="token punctuation">)</span>
    in_file <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'D:\data set\caltech\VOCdevkit\\annotations\set%s_V%s_%s.xml'</span><span class="token operator">%</span><span class="token punctuation">(</span>setxxx<span class="token punctuation">,</span>vxxx<span class="token punctuation">,</span>xxxjpg<span class="token punctuation">)</span><span class="token punctuation">)</span>
    tree<span class="token operator">=</span>ET<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>in_file<span class="token punctuation">)</span>
    root <span class="token operator">=</span> tree<span class="token punctuation">.</span>getroot<span class="token punctuation">(</span><span class="token punctuation">)</span>
    size <span class="token operator">=</span> root<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'size'</span><span class="token punctuation">)</span>
    w <span class="token operator">=</span> int<span class="token punctuation">(</span>size<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'width'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    h <span class="token operator">=</span> int<span class="token punctuation">(</span>size<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>

    <span class="token keyword">for</span> obj <span class="token keyword">in</span> root<span class="token punctuation">.</span>iter<span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        difficult <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'difficult'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
        <span class="token keyword">if</span> int<span class="token punctuation">(</span>difficult<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        xmlbox <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'bndbox'</span><span class="token punctuation">)</span>
        b <span class="token operator">=</span> <span class="token punctuation">(</span>float<span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'xmin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> float<span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'xmax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> float<span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'ymin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> float<span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'ymax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        colors <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token punctuation">(</span>int<span class="token punctuation">(</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>int<span class="token punctuation">(</span>b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>int<span class="token punctuation">(</span>b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>int<span class="token punctuation">(</span>b<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>colors<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span><span class="token string">'D:\data set\caltech\VOCdevkit\JPEGS\%s.jpg'</span><span class="token operator">%</span><span class="token punctuation">(</span>xxxjpg<span class="token punctuation">)</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>               
<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>     
    rootdir <span class="token operator">=</span> <span class="token string">"D:\data set\caltech\VOCdevkit\\annotations"</span>
    <span class="token keyword">for</span> parent<span class="token punctuation">,</span> dirnames<span class="token punctuation">,</span> filenames <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>rootdir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> name <span class="token keyword">in</span> filenames<span class="token punctuation">:</span>
            temp <span class="token operator">=</span> name<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
            setxx <span class="token operator">=</span> temp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
            Vxxx <span class="token operator">=</span> temp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
            xxxjpg <span class="token operator">=</span> temp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
            convert_annotation<span class="token punctuation">(</span>setxx<span class="token punctuation">,</span>Vxxx<span class="token punctuation">,</span>xxxjpg<span class="token punctuation">)</span>          <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-4将jpg图片放在一个统一的文件夹下和xml文件对应"><a href="#2-4将jpg图片放在一个统一的文件夹下和xml文件对应" class="headerlink" title="2.4将jpg图片放在一个统一的文件夹下和xml文件对应"></a>2.4将jpg图片放在一个统一的文件夹下和xml文件对应</h4><p>​        2.3步骤中xml文件已经放在了一个文件夹下，而图片还放在不同目录下，没有和xml标注文件相对应。因此调用<strong>mergejpg.py</strong>文件，将所有图片放在一起，只需修改代码<strong>第6和7行</strong>的输入输出路径即可。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> glob
<span class="token keyword">import</span> shutil
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    imgpathin <span class="token operator">=</span> <span class="token string">'D:\data set\caltech\VOCdevkit\JPEG'</span>
    imgout <span class="token operator">=</span> <span class="token string">'D:\data set\caltech\VOCdevkit\JPEG'</span>
    <span class="token keyword">for</span> subdir <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>imgpathin<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>subdir<span class="token punctuation">)</span>
        file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>imgpathin<span class="token punctuation">,</span> subdir<span class="token punctuation">)</span>
        <span class="token keyword">for</span> subdir1 <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>subdir1<span class="token punctuation">)</span>
            file_path1 <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> subdir1<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>file_path1<span class="token punctuation">)</span>
            <span class="token keyword">for</span> jpg_file <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>file_path1<span class="token punctuation">)</span><span class="token punctuation">:</span>
                src <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>file_path1<span class="token punctuation">,</span> jpg_file<span class="token punctuation">)</span>
                new_name<span class="token operator">=</span>str<span class="token punctuation">(</span>subdir<span class="token operator">+</span><span class="token string">"_"</span><span class="token operator">+</span>subdir1<span class="token operator">+</span><span class="token string">"_"</span><span class="token operator">+</span>jpg_file<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>new_name<span class="token punctuation">)</span>
                dst<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>imgout<span class="token punctuation">,</span>new_name<span class="token punctuation">)</span>
                os<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>src<span class="token punctuation">,</span>dst<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​        我这里输入输出同目录，生成的图片放在了一起。删除不需要的set00-set10文件夹，剩下的名为set0_V000_1.jpg格式图片，总共有<strong>249884</strong>张。如2.3节所述，图片数量比xml文件要多很多。</p>
<h4 id="2-5重命名图片和xml文件"><a href="#2-5重命名图片和xml文件" class="headerlink" title="2.5重命名图片和xml文件"></a>2.5重命名图片和xml文件</h4><p>​        按照“xxxxxx”6位数字格式给图片和xml文件命名方便后续操作。标注有人的图片命名为<strong>xxxxxx.jpg</strong>和命名为<strong>xxxxxx.xml</strong>的xml文件相对应，多余的图片保持原名。调用<strong>renameindex.py</strong>文件，只需要修改代码的<strong>第3和4行</strong>的输入和输出目录即可。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token keyword">import</span> os
xmlpath <span class="token operator">=</span> <span class="token string">'D:/data set/caltech/VOCdevkit/annotations'</span>
imgpath <span class="token operator">=</span> <span class="token string">'D:/data set/caltech/VOCdevkit/JPEG'</span>
index <span class="token operator">=</span> <span class="token number">0</span>
count <span class="token operator">=</span> <span class="token number">0</span>
emptyset <span class="token operator">=</span> set<span class="token punctuation">(</span><span class="token punctuation">)</span>
xmlFiles <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>xmlpath<span class="token punctuation">)</span>
imgFiles <span class="token operator">=</span> os <span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>imgpath<span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token punctuation">(</span>len<span class="token punctuation">(</span>xmlFiles<span class="token punctuation">)</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>imgFiles<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> xml <span class="token keyword">in</span> xmlFiles<span class="token punctuation">:</span>    
    xmlname  <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    imgname <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>imgpath<span class="token punctuation">,</span>xmlname<span class="token operator">+</span><span class="token string">'.jpg'</span><span class="token punctuation">)</span>    
    <span class="token keyword">print</span><span class="token punctuation">(</span>imgname<span class="token punctuation">)</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>imgname<span class="token punctuation">)</span><span class="token punctuation">:</span>
        newName <span class="token operator">=</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#重命名图像</span>
        os<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>imgname<span class="token punctuation">,</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>imgpath<span class="token punctuation">,</span>newName<span class="token operator">+</span><span class="token string">'.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#重命名xml文件</span>
        os<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>xmlpath<span class="token punctuation">,</span>xml<span class="token punctuation">)</span><span class="token punctuation">,</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>xmlpath<span class="token punctuation">,</span>newName<span class="token operator">+</span><span class="token string">'.xml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'============================================'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">,</span>imgname<span class="token punctuation">,</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>imgpath<span class="token punctuation">,</span>newName<span class="token operator">+</span><span class="token string">'.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'__________________________________________'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'xml'</span><span class="token punctuation">,</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>xmlpath<span class="token punctuation">,</span>xml<span class="token punctuation">)</span><span class="token punctuation">,</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>xmlpath<span class="token punctuation">,</span>newName<span class="token operator">+</span><span class="token string">'.xml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'============================================'</span><span class="token punctuation">)</span>
        index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        count <span class="token operator">+=</span> <span class="token number">1</span>
        emptyset<span class="token punctuation">.</span>add<span class="token punctuation">(</span>xmlname<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'_'</span><span class="token operator">+</span>xmlname<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sortedSet <span class="token operator">=</span> sorted<span class="token punctuation">(</span>emptyset<span class="token punctuation">,</span>key<span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> sortedSet<span class="token punctuation">:</span>
    <span class="token keyword">print</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> 
    <span class="token keyword">print</span> <span class="token punctuation">(</span>count<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​        调用完毕在annotations下生成名为xxxxxx.xml格式的标注文件，JPEG下生成xxxxxx.jpg图片，将多余的没有重命名图片删除。可以右键属性查看到标注文件和图片分别有<strong>122187</strong>个，且各自对应。</p>
<h4 id="2-6替换标签"><a href="#2-6替换标签" class="headerlink" title="2.6替换标签"></a>2.6替换标签</h4><p>​        这里网上说是caltech标注中行人还会细划分为几类不同的行人，但我好像没发现，如果有大佬知道欢迎留言，这里为了以防万一还是运行此文件。运行<strong>findPeople.py</strong>将不同类person转换为同类person。代码只需修改<strong>第6和7行</strong>的输入和输出路径即可。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># -*- coding:utf-8 -*-</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> re

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    xmlin <span class="token operator">=</span> <span class="token string">'D:\data set\caltech\VOCdevkit\\annotations'</span>
    xmlout <span class="token operator">=</span> <span class="token string">'D:\data set\caltech\VOCdevkit\\annotations'</span>
    files <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>xmlin<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#编译一个pattern</span>
    pattern <span class="token operator">=</span> re<span class="token punctuation">.</span>compile<span class="token punctuation">(</span><span class="token string">'people'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">#每张图片进行判断</span>
    <span class="token keyword">for</span> file <span class="token keyword">in</span> files<span class="token punctuation">:</span>
        f <span class="token operator">=</span> open<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>xmlin<span class="token punctuation">,</span>file<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
        content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'people'</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token operator">!=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>
            updateFile <span class="token operator">=</span> pattern<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">'person'</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            updateFile <span class="token operator">=</span> content
        <span class="token keyword">with</span> open<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>xmlout<span class="token punctuation">,</span>file<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fout<span class="token punctuation">:</span>
            fout<span class="token punctuation">.</span>write<span class="token punctuation">(</span>updateFile<span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'updating file {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-7对xml文件和jpg图片采样（可选）"><a href="#2-7对xml文件和jpg图片采样（可选）" class="headerlink" title="2.7对xml文件和jpg图片采样（可选）"></a>2.7对xml文件和jpg图片采样（可选）</h4><p>​        因为生成图片过多，我不想训练这么多的内容，选择每<strong>8</strong>帧对图片和标注文件采样，减少训练内容。调用<strong>delete_file.py</strong>采样，仍然保持标注文件和图片对应。代码只需修改<strong>第22行</strong>输入目录和<strong>第14行</strong>的采样频率即可。这里分两步，第一步先对图片采样，然后将图片的路径改为xml文件的路径再对xml文件采样。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/python</span>
<span class="token comment" spellcheck="true"># -*- coding: UTF-8 -*-</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> shutil
<span class="token keyword">def</span> <span class="token function">get_file_path</span><span class="token punctuation">(</span>root_path<span class="token punctuation">,</span> file_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dir_or_files <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>root_path<span class="token punctuation">)</span>
    <span class="token keyword">for</span> dir_file <span class="token keyword">in</span> dir_or_files<span class="token punctuation">:</span>
        dir_file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_path<span class="token punctuation">,</span> dir_file<span class="token punctuation">)</span>
        file_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dir_file_path<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete_file</span><span class="token punctuation">(</span>file_list<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">:</span>
    count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> file_name <span class="token keyword">in</span> file_list<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">%</span> <span class="token number">8</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">#数字自行修改</span>
            count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
        count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    root_path <span class="token operator">=</span> r<span class="token string">"D:\data set\caltech\VOCdevkit\JPEG"</span>  <span class="token comment" spellcheck="true">#先对图片采样，之后更换路劲对标注文件采样。</span>
    file_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    get_file_path<span class="token punctuation">(</span>root_path<span class="token punctuation">,</span> file_list<span class="token punctuation">)</span>
    length <span class="token operator">=</span> len<span class="token punctuation">(</span>file_list<span class="token punctuation">)</span>
    delete_file<span class="token punctuation">(</span>file_list<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​    采样后xml和jpg分别有<strong>15274</strong>张。</p>
<h4 id="2-8重命名xml文件和jpg图片（可选）"><a href="#2-8重命名xml文件和jpg图片（可选）" class="headerlink" title="2.8重命名xml文件和jpg图片（可选）"></a>2.8重命名xml文件和jpg图片（可选）</h4><p>​        2.7步骤采样后删除很多文件，需要重新排列命名。调用<strong>rename_after_cut.py</strong>文件重命名，代码只需修改<strong>第3、4行</strong>路径即可。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#-*- coding:utf-8 -*-</span>
<span class="token keyword">import</span> os
xmlpath <span class="token operator">=</span> <span class="token string">'D:/data set/caltech/VOCdevkit/annotations'</span>
imgpath <span class="token operator">=</span> <span class="token string">'D:/data set/caltech/VOCdevkit/JPEG'</span>
index <span class="token operator">=</span> <span class="token number">0</span>
count <span class="token operator">=</span> <span class="token number">0</span>
emptyset <span class="token operator">=</span> set<span class="token punctuation">(</span><span class="token punctuation">)</span>
xmlFiles <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>xmlpath<span class="token punctuation">)</span>
imgFiles <span class="token operator">=</span> os <span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>imgpath<span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token punctuation">(</span>len<span class="token punctuation">(</span>xmlFiles<span class="token punctuation">)</span><span class="token punctuation">,</span>len<span class="token punctuation">(</span>imgFiles<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> xml <span class="token keyword">in</span> xmlFiles<span class="token punctuation">:</span>    
    xmlname  <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    imgname <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>imgpath<span class="token punctuation">,</span>xmlname<span class="token operator">+</span><span class="token string">'.jpg'</span><span class="token punctuation">)</span>    
    <span class="token keyword">print</span><span class="token punctuation">(</span>imgname<span class="token punctuation">)</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>imgname<span class="token punctuation">)</span><span class="token punctuation">:</span>
        newName <span class="token operator">=</span> str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#重命名图像</span>
        os<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>imgname<span class="token punctuation">,</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>imgpath<span class="token punctuation">,</span>newName<span class="token operator">+</span><span class="token string">'.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#重命名xml文件</span>
        os<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>xmlpath<span class="token punctuation">,</span>xml<span class="token punctuation">)</span><span class="token punctuation">,</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>xmlpath<span class="token punctuation">,</span>newName<span class="token operator">+</span><span class="token string">'.xml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">,</span>imgname<span class="token punctuation">,</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>imgpath<span class="token punctuation">,</span>newName<span class="token operator">+</span><span class="token string">'.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'xml'</span><span class="token punctuation">,</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>xmlpath<span class="token punctuation">,</span>xml<span class="token punctuation">)</span><span class="token punctuation">,</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>xmlpath<span class="token punctuation">,</span>newName<span class="token operator">+</span><span class="token string">'.xml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        index <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        count <span class="token operator">+=</span> <span class="token number">1</span>
        emptyset<span class="token punctuation">.</span>add<span class="token punctuation">(</span>xmlname<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'_'</span><span class="token operator">+</span>xmlname<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sortedSet <span class="token operator">=</span> sorted<span class="token punctuation">(</span>emptyset<span class="token punctuation">,</span>key<span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> sortedSet<span class="token punctuation">:</span>
    <span class="token keyword">print</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> 
    <span class="token keyword">print</span> <span class="token punctuation">(</span>count<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-9生成txt文件指定训练集、验证集、数据集、训练验证集"><a href="#2-9生成txt文件指定训练集、验证集、数据集、训练验证集" class="headerlink" title="2.9生成txt文件指定训练集、验证集、数据集、训练验证集"></a>2.9生成txt文件指定训练集、验证集、数据集、训练验证集</h4><p>​        调用<strong>generate_txt.py</strong>生成trainval.txt、test.txt、train.txt、val.txt四个文件，这些文件内容<strong>只包含图像名字的数字索引，也就是xxxxxx</strong>。因为要转换为标准VOC数据集格式，这几个文件最后<strong>放入VOC2007/ImageSets/Main</strong>文件夹中。代码只需要修改<strong>第6和7行</strong>的目录，<strong>第11行和12行</strong>的训练集测试集百分比即可。这里我选取测试集占比28%，因此trainval.txt有<strong>10997</strong>行，test.txt有<strong>4277</strong>行，加起来正好<strong>15274</strong>行。每次选取图片均是随机选取，所以后面的文件格式跟我相同即可，内容是不一样的。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#coding=utf-8</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> random
<span class="token keyword">import</span> time

xmlfilepath<span class="token operator">=</span><span class="token string">'D:/data set/caltech/VOCdevkit/annotations'</span>
saveBasePath<span class="token operator">=</span><span class="token string">'D:/data set/caltech/VOCdevkit/txt'</span>
<span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>saveBasePath<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>saveBasePath<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#设置训练集和测试集的百分比，训练验证集72%，测试集28%，训练集和验证集在对半分。</span>
trainval_percent<span class="token operator">=</span><span class="token number">0.72</span>
train_percent<span class="token operator">=</span><span class="token number">0.5</span>
total_xml <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>xmlfilepath<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#所有的</span>

num <span class="token operator">=</span> len<span class="token punctuation">(</span>total_xml<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">#xml文件的数量</span>
index_list <span class="token operator">=</span> range<span class="token punctuation">(</span>num<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#生成一个index列表</span>
trainval_num <span class="token operator">=</span> int<span class="token punctuation">(</span>num<span class="token operator">*</span>trainval_percent<span class="token punctuation">)</span> 
train_num <span class="token operator">=</span> int<span class="token punctuation">(</span>trainval_num<span class="token operator">*</span>train_percent<span class="token punctuation">)</span>
trainval_index <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>index_list<span class="token punctuation">,</span>trainval_num<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#从index_list中随机采样trainval_num数量的内容（正好一半）</span>
train_index <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>trainval_index<span class="token punctuation">,</span>train_num<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#再次取一半</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"train and val size"</span><span class="token punctuation">,</span> trainval_num<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"train size"</span><span class="token punctuation">,</span> train_num<span class="token punctuation">)</span>

ftrainval <span class="token operator">=</span> open<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>saveBasePath<span class="token punctuation">,</span><span class="token string">'trainval.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
ftest <span class="token operator">=</span> open<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>saveBasePath<span class="token punctuation">,</span><span class="token string">'test.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
ftrain <span class="token operator">=</span> open<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>saveBasePath<span class="token punctuation">,</span><span class="token string">'train.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
fval <span class="token operator">=</span> open<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>saveBasePath<span class="token punctuation">,</span><span class="token string">'val.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Start time</span>
start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i  <span class="token keyword">in</span> index_list<span class="token punctuation">:</span>
    name <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>total_xml<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\n'</span>    
    <span class="token keyword">if</span> i <span class="token keyword">in</span> trainval_index<span class="token punctuation">:</span>
        ftrainval<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> i <span class="token keyword">in</span> train_index<span class="token punctuation">:</span>
            ftrain<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            fval<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        ftest<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># End time</span>
end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
seconds <span class="token operator">=</span> end <span class="token operator">-</span> start
<span class="token keyword">print</span><span class="token punctuation">(</span> <span class="token string">"Time taken : {0} seconds"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>seconds<span class="token punctuation">)</span><span class="token punctuation">)</span>
ftrainval<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
ftrain<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
fval<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
ftest <span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-使用yolov3训练caltech数据集"><a href="#3-使用yolov3训练caltech数据集" class="headerlink" title="3.使用yolov3训练caltech数据集"></a>3.使用yolov3训练caltech数据集</h3><p>​        这里改自<a href="https://github.com/AlexeyAB/darknet#how-to-use-on-the-command-line。" target="_blank" rel="noopener">https://github.com/AlexeyAB/darknet#how-to-use-on-the-command-line。</a></p>
<p>​        这里前期的准备工作已经完成，我们把annotations文件夹和JPEG文件夹以及txt文件夹里面的内容按照VOC数据集的格式存放。这里我为了编译方便用的Ubuntu系统，路径是ubuntu风格，用windows也一样。Alexey版本的yolo下，在<strong>data</strong>目录里建立<strong>VOC</strong>文件夹，VOC文件夹里建立<strong>VOCdevkit</strong>文件夹，VOCdevkit文件夹里建立<strong>VOC2007</strong>文件夹，VOC2007文件夹下建立<strong>Annotations、ImageSets、JPEGImages</strong>三个文件夹，其中<strong>Annotations将所有的xml文件放入，JPETImages将所有图片放入，ImageSets文件夹下建立Main文件夹并放入2.9步骤生成的4个txt文件。</strong>注意这里目录名字一定要打对，仔细核对。</p>
<h4 id="3-1生成训练所需要的的2007-test-txt、2007-train-txt、2007-val-txt、train-all-txt、train-txt以及lables文件夹"><a href="#3-1生成训练所需要的的2007-test-txt、2007-train-txt、2007-val-txt、train-all-txt、train-txt以及lables文件夹" class="headerlink" title="3.1生成训练所需要的的2007_test.txt、2007_train.txt、2007_val.txt、train.all.txt、train.txt以及lables文件夹"></a>3.1生成训练所需要的的2007_test.txt、2007_train.txt、2007_val.txt、train.all.txt、train.txt以及lables文件夹</h4><p>​      将<strong>voc_lable.py</strong>文件<strong>放在和VOCdevkit同级目录</strong>下，调用<strong>voc_lable.py</strong>在同级目录下生成2007_test.txt、2007_train.txt、2007_val.txt、train.all.txt、train.txt5个文件,里面内容是图片的路径。VOC2007文件夹下生成<strong>lables</strong>文件夹，里面是一堆txt文件，每个文件表示对应图片里归一化的xywh值。代码修改自VOC数据集的voc_lable.py文件，代码路径不建议修改，只是<strong>文件一定放在VOCdevkit同级目录</strong>下。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> xml<span class="token punctuation">.</span>etree<span class="token punctuation">.</span>ElementTree <span class="token keyword">as</span> ET
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> os
<span class="token keyword">from</span> os <span class="token keyword">import</span> listdir<span class="token punctuation">,</span> getcwd
<span class="token keyword">from</span> os<span class="token punctuation">.</span>path <span class="token keyword">import</span> join

sets<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'2007'</span><span class="token punctuation">,</span> <span class="token string">'train'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'2007'</span><span class="token punctuation">,</span> <span class="token string">'val'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'2007'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"person"</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">convert</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> box<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dw <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token punctuation">(</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    dh <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token punctuation">(</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2.0</span> <span class="token operator">-</span> <span class="token number">1</span>
    y <span class="token operator">=</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2.0</span> <span class="token operator">-</span> <span class="token number">1</span>
    w <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    h <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    x <span class="token operator">=</span> x<span class="token operator">*</span>dw
    w <span class="token operator">=</span> w<span class="token operator">*</span>dw
    y <span class="token operator">=</span> y<span class="token operator">*</span>dh
    h <span class="token operator">=</span> h<span class="token operator">*</span>dh
    <span class="token keyword">return</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>w<span class="token punctuation">,</span>h<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">convert_annotation</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> image_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    in_file <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'VOCdevkit/VOC%s/Annotations/%s.xml'</span><span class="token operator">%</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> image_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
    out_file <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'VOCdevkit/VOC%s/labels/%s.txt'</span><span class="token operator">%</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> image_id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
    tree<span class="token operator">=</span>ET<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>in_file<span class="token punctuation">)</span>
    root <span class="token operator">=</span> tree<span class="token punctuation">.</span>getroot<span class="token punctuation">(</span><span class="token punctuation">)</span>
    size <span class="token operator">=</span> root<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'size'</span><span class="token punctuation">)</span>
    w <span class="token operator">=</span> int<span class="token punctuation">(</span>size<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'width'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    h <span class="token operator">=</span> int<span class="token punctuation">(</span>size<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>

    <span class="token keyword">for</span> obj <span class="token keyword">in</span> root<span class="token punctuation">.</span>iter<span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        difficult <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'difficult'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
        cls <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
        <span class="token keyword">if</span> cls <span class="token operator">not</span> <span class="token keyword">in</span> classes <span class="token operator">or</span> int<span class="token punctuation">(</span>difficult<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        cls_id <span class="token operator">=</span> classes<span class="token punctuation">.</span>index<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>
        xmlbox <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'bndbox'</span><span class="token punctuation">)</span>
        b <span class="token operator">=</span> <span class="token punctuation">(</span>float<span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'xmin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> float<span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'xmax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> float<span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'ymin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> float<span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'ymax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        bb <span class="token operator">=</span> convert<span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
        out_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>cls_id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>str<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token keyword">for</span> a <span class="token keyword">in</span> bb<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>

wd <span class="token operator">=</span> getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> year<span class="token punctuation">,</span> image_set <span class="token keyword">in</span> sets<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'VOCdevkit/VOC%s/labels/'</span><span class="token operator">%</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">'VOCdevkit/VOC%s/labels/'</span><span class="token operator">%</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span><span class="token punctuation">)</span>
    image_ids <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'VOCdevkit/VOC%s/ImageSets/Main/%s.txt'</span><span class="token operator">%</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> image_set<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
    list_file <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'%s_%s.txt'</span><span class="token operator">%</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> image_set<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> image_id <span class="token keyword">in</span> image_ids<span class="token punctuation">:</span>
        list_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'%s/VOCdevkit/VOC%s/JPEGImages/%s.jpg\n'</span><span class="token operator">%</span><span class="token punctuation">(</span>wd<span class="token punctuation">,</span> year<span class="token punctuation">,</span> image_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        convert_annotation<span class="token punctuation">(</span>year<span class="token punctuation">,</span> image_id<span class="token punctuation">)</span>
    list_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"cat 2007_train.txt 2007_val.txt  > train.txt"</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"cat 2007_train.txt 2007_val.txt 2007_test.txt  > train.all.txt"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="3-2创建yolov3-caltech-cfg文件"><a href="#3-2创建yolov3-caltech-cfg文件" class="headerlink" title="3.2创建yolov3-caltech.cfg文件"></a>3.2创建yolov3-caltech.cfg文件</h4><p>​        创建与<code>yolov3-voc.cfg</code>类似的<code>yolov3-caltech.cfg</code>，放入cfg文件夹下：</p>
<ul>
<li>设置training下的batch=64，subdivisions=8.（视电脑配置决定）</li>
<li>max_batches设置30000。（自己决定）</li>
<li>steps参数为80%和90%max_batches，这里是steps=24000，27000.</li>
<li>网络输入长宽必须能整除32，这里是416x416.</li>
<li>3个yolo层的classes类别数改为1.</li>
<li>3个yolo层前一个卷积层的filter数为18.（公式是filters=(classes+5)×3）</li>
</ul>
<h4 id="3-3创建caltech-names文件"><a href="#3-3创建caltech-names文件" class="headerlink" title="3.3创建caltech.names文件"></a>3.3创建caltech.names文件</h4><p>​        创建类似<code>voc.names</code>的<code>caltech.names</code>放入data文件夹下，文件里<strong>只有person</strong>。</p>
<h4 id="3-4创建caltech-data文件"><a href="#3-4创建caltech-data文件" class="headerlink" title="3.4创建caltech.data文件"></a>3.4创建caltech.data文件</h4><p>​        创建类似<code>voc.data</code>的<code>caltech.data</code>放入cfg文件夹下，修改为自己对应的路径</p>
<pre class="line-numbers language-python"><code class="language-python">classes<span class="token operator">=</span> <span class="token number">1</span> <span class="token comment" spellcheck="true"># 你的类别的个数</span>
train  <span class="token operator">=</span><span class="token operator">/</span>home<span class="token operator">/</span>davy<span class="token operator">/</span>下载<span class="token operator">/</span>yolo_each_version<span class="token operator">/</span>alexey_simple<span class="token operator">/</span>data<span class="token operator">/</span>VOC<span class="token operator">/</span>train<span class="token punctuation">.</span>txt <span class="token comment" spellcheck="true"># 存储用于训练的图片位置</span>
valid  <span class="token operator">=</span><span class="token operator">/</span>home<span class="token operator">/</span>davy<span class="token operator">/</span>下载<span class="token operator">/</span>yolo_each_version<span class="token operator">/</span>alexey_simple<span class="token operator">/</span>data<span class="token operator">/</span>VOC<span class="token operator">/</span>2007_test<span class="token punctuation">.</span>txt<span class="token comment" spellcheck="true"># 存储用于测试的图片的位置</span>
names <span class="token operator">=</span> data<span class="token operator">/</span>caltech<span class="token punctuation">.</span>names <span class="token comment" spellcheck="true"># 每行一个类别的名称</span>
backup <span class="token operator">=</span> backup<span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="3-5开始训练"><a href="#3-5开始训练" class="headerlink" title="3.5开始训练"></a>3.5开始训练</h4><ul>
<li><code>./darknet detector train cfg/caltech.data cfg/yolov3-caltech.cfg darknet53.conv.74 -map</code>实时显示map</li>
<li><code>./darknet detector train cfg/caltech.data cfg/yolov3-caltech.cfg darknet53.conv.74 2&gt;1 | tee visualization/train_yolov3.log</code>可视化中间参数并保存终端内容到visualization/train_yolov3.log文件中</li>
</ul>
<h3 id="4绘制fppi-miss-rate图"><a href="#4绘制fppi-miss-rate图" class="headerlink" title="4绘制fppi miss rate图"></a>4绘制fppi miss rate图</h3><p>​        这里参考了<a href="https://www.cnblogs.com/ya-cpp/p/8282383.html的内容。" target="_blank" rel="noopener">https://www.cnblogs.com/ya-cpp/p/8282383.html的内容。</a></p>
<p>​        这里运用的是matlab下的<code>[am,fppi,missRate] = evaluateDetectionMissRate(detectionResults,trainingData)</code>函数。<code>detectionResults</code>是自己算法的预测结果，类型如下图所示：</p>
<img width="600" src="https://i.loli.net/2020/11/09/OdYCliU8mPhD7RB.png">

<p>Boxes代表坐标信息（<strong>左上角xy、w、h</strong>），维度很高是因为一张图中有多个预测框，Src是对应的置信度。</p>
<p><code>trainingData</code>是真实的gt结果，类型如下图所示：</p>
<img width="600" src="https://i.loli.net/2020/11/09/xQc2NaoXDpKgkhd.png">

<p>Boxes代表真实坐标信息，name是图片名称。</p>
<h4 id="4-1生成detectionResults内容"><a href="#4-1生成detectionResults内容" class="headerlink" title="4.1生成detectionResults内容"></a>4.1生成detectionResults内容</h4><p>​        训练完毕后需要在主目录下创建<strong>results</strong>文件夹，在源码中的<strong>detector.c</strong>文件中<strong>validate_detector</strong>函数下找到<code>int classes = l.classes;</code>在后面添加<code>char *classesnum = option_find_str(options, "classes", "80");classes = atoi(classesnum);</code>这样在文件夹results中生成的txt文件才和你自定义的类别数相同。</p>
<p>​        在终端输入<code>./darknet detector valid cfg/caltech.data cfg/yolov3-caltech.cfg backup/yolov3-caltech_last.weights -out "" -gpu 0</code>，权重文件根据自己的修改。<strong>这会在results文件夹下生成person.txt</strong>。这个文件是我们根据3.4步骤中valid路径的2007_test.txt中对应图片的自己预测的结果，每张图会生成几个预测框，里面包含图片名、置信度、坐标这几个内容。person.txt文件部分内容如下(每个人预测结果不同)：</p>
<pre class="line-numbers language-bash"><code class="language-bash">000001 0.559587 224.088120 133.759949 231.628952 146.779480
000001 0.145668 232.491028 132.304642 239.329895 148.342789
000009 0.468610 228.921371 131.483200 235.663467 144.126236
000009 0.257587 235.649506 132.068237 241.292664 143.776550
000009 0.011003 247.271637 131.625412 253.146362 143.372421
000010 0.939331 592.104309 169.121338 608.267395 212.208038
000010 0.787617 480.261322 171.480667 491.733246 196.037827
000010 0.014944 475.234589 171.413132 485.475250 195.526871<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​        在主目录下创建<strong>caltech_test</strong>文件夹，里面创建<strong>out.txt,out1.txt,out2.txt,person_gt.txt,person_gt_matlab.txt</strong>这几个空文件。文件内容下面会解释。</p>
<p>​        调用<strong>pro_det.py</strong>文件，生成三个文件，一个文件out.txt只存储图片名<strong>（根据person.txt得出，重复的图片名只计一次）</strong>，一个文件out1.txt只包含置信度<strong>（一个图片内所有预测框的置信度放在一行中，每个预测框的置信度用分号间隔）</strong>，一个文件out2.txt保存坐标<strong>（一个图片内所有预测框的四个坐标放在一行，每个框的内容之间用分号间隔，四个坐标之间用逗号间隔）</strong>。三个文件内容分别对应。代码只需修改<strong>第4、5、63行</strong>路径。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#coding=utf-8</span>
<span class="token keyword">import</span> os
<span class="token keyword">def</span> <span class="token function">generate_result</span><span class="token punctuation">(</span>resource_path<span class="token punctuation">,</span> des_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    des_path1 <span class="token operator">=</span> <span class="token string">"/home/davy/下载/yolo_each_version/alexey_simple/caltech_test/out1.txt"</span>
    des_path2 <span class="token operator">=</span> <span class="token string">"/home/davy/下载/yolo_each_version/alexey_simple/caltech_test/out2.txt"</span>

    rf <span class="token operator">=</span> open<span class="token punctuation">(</span>resource_path<span class="token punctuation">)</span>

    content <span class="token operator">=</span> rf<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cnt <span class="token operator">=</span> <span class="token number">0</span>
    tmp_dick <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">#tmp_dick是一个字典，cls表示图片名字，bbox表示图片的置信度和四个坐标</span>
    <span class="token keyword">while</span> content<span class="token punctuation">:</span>
        res <span class="token operator">=</span> content<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>
        cls <span class="token operator">=</span> str<span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        bbox <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true">#一个图有多个框</span>
        <span class="token keyword">if</span> cls <span class="token keyword">in</span> tmp_dick<span class="token punctuation">:</span>
            tmp_dick<span class="token punctuation">[</span>cls<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>bbox<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#一个图就一个框</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            tmp_dick<span class="token punctuation">[</span>cls<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>bbox<span class="token punctuation">]</span>
        content <span class="token operator">=</span> rf<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
    rf<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    wfname <span class="token operator">=</span> open<span class="token punctuation">(</span>des_path<span class="token punctuation">,</span> <span class="token string">"r+"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#图片名,a+表示追加写入方式，r+覆盖写入</span>
    wfsrc <span class="token operator">=</span> open<span class="token punctuation">(</span>des_path1<span class="token punctuation">,</span> <span class="token string">"r+"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#置信度</span>
    wfbox <span class="token operator">=</span> open<span class="token punctuation">(</span>des_path2<span class="token punctuation">,</span> <span class="token string">"r+"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#坐标</span>
    <span class="token comment" spellcheck="true">#字典的键，也就是图片名</span>
    <span class="token keyword">for</span> key_ <span class="token keyword">in</span> tmp_dick<span class="token punctuation">:</span>
        wfname<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>key_<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#字典的值，就是每个bbox（包含置信度和坐标）</span>
        <span class="token keyword">for</span> detail <span class="token keyword">in</span> tmp_dick<span class="token punctuation">[</span>key_<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true">#取一个bbox中的一个值，分别是置信度，x,y,w,h</span>
            <span class="token keyword">for</span> index <span class="token keyword">in</span> detail<span class="token punctuation">:</span>
                <span class="token keyword">if</span> index <span class="token operator">==</span> detail<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    wfsrc<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> index <span class="token keyword">is</span> detail<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#左上角x</span>
                        tmpp1 <span class="token operator">=</span> index
                        wfbox<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token punctuation">(</span>float<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> index <span class="token keyword">is</span> detail<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#左上角y</span>
                        tmpp2 <span class="token operator">=</span> index
                        wfbox<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token punctuation">(</span>float<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> index <span class="token keyword">is</span> detail<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#宽</span>
                        wfbox<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token punctuation">(</span>float<span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">-</span> float<span class="token punctuation">(</span>tmpp1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> index <span class="token keyword">is</span> detail<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#高</span>
                        wfbox<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token punctuation">(</span>float<span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">-</span> float<span class="token punctuation">(</span>tmpp2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> index <span class="token keyword">is</span> <span class="token operator">not</span> detail<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#每个坐标间用，隔开</span>
                        wfbox<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> len<span class="token punctuation">(</span>tmp_dick<span class="token punctuation">[</span>key_<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> detail <span class="token keyword">is</span> <span class="token operator">not</span> tmp_dick<span class="token punctuation">[</span>key_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    wfsrc<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#不同框间的内容用；隔开</span>
                    wfbox<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span>

        wfname<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#不同图片换行</span>
        wfsrc<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
        wfbox<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>

    wfname<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    wfsrc<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    wfbox<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#生成三个文件，out保存图片名，换行间隔；out1保存置信度，一个图片的置信度分号间隔，不同图片换行；out2保存坐标信息（左上和右下），一个图片的坐标信息分号间隔，每个坐标直接逗号间隔，图片换行。</span>
generate_result<span class="token punctuation">(</span><span class="token string">"/home/davy/下载/yolo_each_version/alexey_simple/results/person.txt"</span><span class="token punctuation">,</span> <span class="token string">"/home/davy/下载/yolo_each_version/alexey_simple/caltech_test/out.txt"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​        out.txt部分内容如下(每个人预测结果不同):</p>
<pre><code>000001,
000009,
000010,
000020,
000025,
000028,</code></pre><p>​        out1.txt部分内容如下(每个人预测结果不同)：</p>
<pre><code>0.559587;0.145668
0.468610;0.257587;0.011003
0.939331;0.787617;0.014944
0.867930;0.172820;0.022374;0.005487;0.005403
0.827769;0.011797;0.008957</code></pre><p>​        out2.txt部分内容如下(每个人预测结果不同)：</p>
<pre><code>224.08812,133.759949,7.540831999999995,13.019531;232.491028,132.304642,6.838866999999993,16.03814700000001
228.921371,131.4832,6.742096000000004,12.643035999999995;235.649506,132.068237,5.643158,11.708312999999976;247.271637,131.625412,5.874725000000012,11.747008999999991
592.104309,169.121338,16.16308600000002,43.08669999999998;480.261322,171.480667,11.471924000000001,24.557159999999982;475.234589,171.413132,10.240660999999989,24.11373900000001
233.762619,130.848083,7.07607999999999,11.57074;230.70842,130.462173,6.369751000000008,12.236480999999998;247.076218,130.692719,6.628844999999984,10.81832799999998;385.98465,168.248779,11.765930000000026,20.181701999999973;213.189636,131.733978,7.869202000000001,11.511993999999987
594.865295,123.218018,22.319703000000004,57.115263999999996;568.346802,130.529251,17.81664999999998,43.75082400000002;633.757751,114.223183,6.242249000000015,78.37160499999999  </code></pre><p>​        这里我每次生的的预测结果数量总是比2007_test.txt中图片数量少几张，就是总有几张没有给出预测，不过这并不影响我们后续的步骤。</p>
<h4 id="4-2生成trainingData内容"><a href="#4-2生成trainingData内容" class="headerlink" title="4.2生成trainingData内容"></a>4.2生成trainingData内容</h4><p>​        上一步生成的out.txt文件中是你预测的测试集图片名字。这一步是找到预测图片相对应的真实坐标信息的xml格式的标注文件并转换为txt类型。调用<strong>xml2txt.py</strong>文件，代码同样必须放在<strong>和VOCdevkit同级目录下</strong>，此外只需修改<strong>第18、35的</strong>路径即可。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> xml<span class="token punctuation">.</span>etree<span class="token punctuation">.</span>ElementTree <span class="token keyword">as</span> ET
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> os
<span class="token keyword">from</span> os <span class="token keyword">import</span> listdir<span class="token punctuation">,</span> getcwd
<span class="token keyword">from</span> os<span class="token punctuation">.</span>path <span class="token keyword">import</span> join
classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"person"</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">convert</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">#左上角和wh</span>
    x <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    y <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    w <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    h <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>w<span class="token punctuation">,</span>h<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">convert_annotation</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> image_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    in_file <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'VOCdevkit/VOC%s/Annotations/%s.xml'</span><span class="token operator">%</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> image_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#存放xml格式文件的目录</span>
    out_file <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'/home/davy/下载/yolo_each_version/alexey_simple/caltech_test/person_gt.txt'</span><span class="token punctuation">,</span> <span class="token string">'a+'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#保存到这个文件中，a+以追加方式写入</span>
    tree<span class="token operator">=</span>ET<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>in_file<span class="token punctuation">)</span>
    root <span class="token operator">=</span> tree<span class="token punctuation">.</span>getroot<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> obj <span class="token keyword">in</span> root<span class="token punctuation">.</span>iter<span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        difficult <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'difficult'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
        cls <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
        <span class="token keyword">if</span> cls <span class="token operator">not</span> <span class="token keyword">in</span> classes <span class="token operator">or</span> int<span class="token punctuation">(</span>difficult<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token comment" spellcheck="true">#cls_id = classes.index(cls)#改成人的话只有1类，cls_id永远为0</span>
        xmlbox <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'bndbox'</span><span class="token punctuation">)</span>
        b <span class="token operator">=</span> <span class="token punctuation">(</span>float<span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'xmin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> float<span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'xmax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> float<span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'ymin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> float<span class="token punctuation">(</span>xmlbox<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'ymax'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        bb <span class="token operator">=</span> convert<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>bb<span class="token punctuation">)</span>
        out_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>image_id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>str<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token keyword">for</span> a <span class="token keyword">in</span> bb<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#图片名+空格+坐标信息（坐标之间空格间隔）</span>
    out_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#读取out文件下对应的图片名，并去掉逗号</span>
image_ids <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'/home/davy/下载/yolo_each_version/alexey_simple/caltech_test/out.txt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>image_ids<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    image_ids<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> image_ids<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment" spellcheck="true">#print(image_ids)</span>
<span class="token keyword">for</span> image_id <span class="token keyword">in</span> image_ids<span class="token punctuation">:</span>
    convert_annotation<span class="token punctuation">(</span><span class="token number">2007</span><span class="token punctuation">,</span> image_id<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​        这里生成的<strong>person_gt.txt</strong>部分内容如下：</p>
<pre><code>000001 228.04708948403487 132.5344370077146 6.439862509174759 12.555317447834682
000009 230.92744661144314 131.24515230156234 7.053654320016761 13.13606348956688
000010 591.1319702602229 168.52973977695154 18.088599752168648 44.33240396530363
000010 478.6104328881311 167.79792175807526 11.85185185185179 25.55877616747182
000020 233.06535999869328 129.9418563797974 6.9233349203163925 13.112218043096448</code></pre><p>​        可以看到一张图片可能包含多个gt框，需要把一张图片的内容放在一行来表示。调用<strong>pro_train.py</strong>文件处理，生成<strong>person_gt_matlab</strong>.txt。代码只需修改<strong>第52行</strong>路径即可。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#coding=utf-8</span>
<span class="token keyword">import</span> os
<span class="token keyword">def</span> <span class="token function">generate_result</span><span class="token punctuation">(</span>resource_path<span class="token punctuation">,</span> des_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rf <span class="token operator">=</span> open<span class="token punctuation">(</span>resource_path<span class="token punctuation">)</span>

    content <span class="token operator">=</span> rf<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cnt <span class="token operator">=</span> <span class="token number">0</span>
    tmp_dick <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">#tmp_dick是一个字典，cls表示图片名字，bbox表示图片四个坐标</span>
    <span class="token keyword">while</span> content<span class="token punctuation">:</span>
        res <span class="token operator">=</span> content<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>
        cls <span class="token operator">=</span> str<span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        bbox <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"cls:"</span><span class="token punctuation">,</span>cls<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"bbox"</span><span class="token punctuation">,</span> bbox<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#一个图有多个框</span>
        <span class="token keyword">if</span> cls <span class="token keyword">in</span> tmp_dick<span class="token punctuation">:</span>
            tmp_dick<span class="token punctuation">[</span>cls<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>bbox<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#一个图就一个框</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            tmp_dick<span class="token punctuation">[</span>cls<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>bbox<span class="token punctuation">]</span>
            cnt <span class="token operator">+=</span> <span class="token number">1</span>
        content <span class="token operator">=</span> rf<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#print(content)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>tmp_dick<span class="token punctuation">)</span>
    rf<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    wfname <span class="token operator">=</span> open<span class="token punctuation">(</span>des_path<span class="token punctuation">,</span> <span class="token string">"r+"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#图片名,r+表示覆盖写入方式</span>
    <span class="token comment" spellcheck="true">#字典的键，也就是图片名</span>
    <span class="token keyword">for</span> key_ <span class="token keyword">in</span> tmp_dick<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">#print("key:",key_)</span>
        wfname<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>key_<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#字典的值，就是每个bbox（包含坐标）</span>
        <span class="token keyword">for</span> detail <span class="token keyword">in</span> tmp_dick<span class="token punctuation">[</span>key_<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true">#取一个bbox中的一个值，分别是x,y,w,h</span>
            <span class="token keyword">for</span> index <span class="token keyword">in</span> detail<span class="token punctuation">:</span>
                <span class="token comment" spellcheck="true">#print("index:",index)</span>
                <span class="token keyword">if</span> index <span class="token keyword">is</span> detail<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#左上角x</span>
                    wfname<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token punctuation">(</span>float<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> index <span class="token keyword">is</span> detail<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#左上角y</span>
                    wfname<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token punctuation">(</span>float<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> index <span class="token keyword">is</span> detail<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#宽</span>
                    wfname<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token punctuation">(</span>float<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> index <span class="token keyword">is</span> detail<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#高</span>
                    wfname<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span><span class="token punctuation">(</span>float<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> index <span class="token keyword">is</span> <span class="token operator">not</span> detail<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#每个坐标间用，隔开</span>
                    wfname<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> len<span class="token punctuation">(</span>tmp_dick<span class="token punctuation">[</span>key_<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> detail <span class="token keyword">is</span> <span class="token operator">not</span> tmp_dick<span class="token punctuation">[</span>key_<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    wfname<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#不同框间的内容用；隔开</span>
        wfname<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#不同图片换行</span>
    wfname<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
generate_result<span class="token punctuation">(</span><span class="token string">"/home/davy/下载/yolo_each_version/alexey_simple/caltech_test/person_gt.txt"</span><span class="token punctuation">,</span> <span class="token string">"/home/davy/下载/yolo_each_version/alexey_simple/caltech_test/person_gt_matlab.txt"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​        生成的person_gt_matlab.txt和out.txt、out1.txt、out2.txt的内容对应。部分内容如下所示：</p>
<pre><code>000001,228.04708948403487 132.5344370077146 6.439862509174759 12.555317447834682
000009,230.92744661144314 131.24515230156234 7.053654320016761 13.13606348956688
000010,591.1319702602229 168.52973977695154 18.088599752168648 44.33240396530363;478.6104328881311 167.79792175807526 11.85185185185179 25.55877616747182
000020,233.06535999869328 129.9418563797974 6.9233349203163925 13.112218043096448
000025,598.681926683717 129.96268826371127 19.121328502415395 45.68222222222224</code></pre><h4 id="4-3绘制fppi-miss-rate曲线"><a href="#4-3绘制fppi-miss-rate曲线" class="headerlink" title="4.3绘制fppi miss rate曲线"></a>4.3绘制fppi miss rate曲线</h4><p>​        这里我们需要的数据已经处理完毕，可以开始转到matlab画图了。首先调用<strong>detectionResults.m</strong>生成matlab所需要的预测结果格式。代码修改<strong>第1和2行</strong>的路径，<strong>第11和12行</strong>你生成结果的行数。</p>
<pre class="line-numbers language-matlab"><code class="language-matlab">fid1<span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span>"D<span class="token operator">:</span><span class="token operator">\</span>Desktop<span class="token operator">\</span>ubuntu<span class="token operator">-</span>shared<span class="token operator">-</span>files<span class="token operator">\</span>FPPI<span class="token operator">-</span>miss rate<span class="token operator">\</span>caltech<span class="token operator">-</span>none<span class="token operator">\</span>out2<span class="token punctuation">.</span>txt"<span class="token punctuation">,</span> "rt"<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">%坐标信息</span>
fid2<span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span>"D<span class="token operator">:</span><span class="token operator">\</span>Desktop<span class="token operator">\</span>ubuntu<span class="token operator">-</span>shared<span class="token operator">-</span>files<span class="token operator">\</span>FPPI<span class="token operator">-</span>miss rate<span class="token operator">\</span>caltech<span class="token operator">-</span>none<span class="token operator">\</span>out1<span class="token punctuation">.</span>txt"<span class="token punctuation">,</span> "rt"<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">%置信度</span>

data1 <span class="token operator">=</span> <span class="token function">textscan</span><span class="token punctuation">(</span>fid1<span class="token punctuation">,</span> <span class="token string">'%s'</span><span class="token punctuation">,</span> <span class="token string">'delimiter'</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data2 <span class="token operator">=</span> <span class="token function">textscan</span><span class="token punctuation">(</span>fid2<span class="token punctuation">,</span> <span class="token string">'%s'</span><span class="token punctuation">,</span> <span class="token string">'delimiter'</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

data1 <span class="token operator">=</span> data1<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
data2 <span class="token operator">=</span> data2<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token function">get_scr_bbox</span><span class="token punctuation">(</span><span class="token number">4258</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">struct</span><span class="token punctuation">(</span><span class="token string">'Boxes'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'Scr'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token number">i</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">4258</span>
    A <span class="token operator">=</span> data1<span class="token punctuation">{</span><span class="token number">i</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    A <span class="token operator">=</span> <span class="token function">cellstr</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">;</span>
    A <span class="token operator">=</span> <span class="token function">str2num</span><span class="token punctuation">(</span><span class="token function">cell2mat</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    B <span class="token operator">=</span> data2<span class="token punctuation">{</span><span class="token number">i</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    B <span class="token operator">=</span> <span class="token function">cellstr</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">;</span>
    B <span class="token operator">=</span> <span class="token function">str2num</span><span class="token punctuation">(</span><span class="token function">cell2mat</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token function">get_scr_bbox</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Boxes <span class="token operator">=</span> A<span class="token punctuation">;</span>
    <span class="token function">get_scr_bbox</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Scr <span class="token operator">=</span> B<span class="token punctuation">;</span>
<span class="token keyword">end</span>
get_scr_bbox <span class="token operator">=</span> <span class="token function">struct2table</span><span class="token punctuation">(</span>get_scr_bbox<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">fclose</span><span class="token punctuation">(</span>fid1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fclose</span><span class="token punctuation">(</span>fid2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​        接下来调用<strong>trainingData.m</strong>生成matlab所需要的gt框结果的格式。代码修改<strong>第1、8、9行</strong>。</p>
<pre class="line-numbers language-matlab"><code class="language-matlab">fid<span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span>"D<span class="token operator">:</span><span class="token operator">\</span>Desktop<span class="token operator">\</span>ubuntu<span class="token operator">-</span>shared<span class="token operator">-</span>files<span class="token operator">\</span>FPPI<span class="token operator">-</span>miss rate<span class="token operator">\</span>caltech<span class="token operator">-</span>none<span class="token operator">\</span>person_gt_matlab<span class="token punctuation">.</span>txt"<span class="token punctuation">,</span> "rt"<span class="token punctuation">)</span><span class="token punctuation">;</span>

data <span class="token operator">=</span> <span class="token function">textscan</span><span class="token punctuation">(</span>fid<span class="token punctuation">,</span> <span class="token string">'%s'</span><span class="token punctuation">,</span> <span class="token string">'delimiter'</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

data <span class="token operator">=</span> data<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token function">get_results</span><span class="token punctuation">(</span><span class="token number">4258</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">struct</span><span class="token punctuation">(</span><span class="token string">'Boxes'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token number">i</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">4258</span>
    A <span class="token operator">=</span> data<span class="token punctuation">{</span><span class="token number">i</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    A <span class="token operator">=</span> <span class="token function">regexp</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">,</span> <span class="token string">'split'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">get_results</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">%图片名</span>
    B <span class="token operator">=</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    B <span class="token operator">=</span> <span class="token function">str2num</span><span class="token punctuation">(</span><span class="token function">cell2mat</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">get_results</span><span class="token punctuation">(</span><span class="token number">i</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Boxes <span class="token operator">=</span> B<span class="token punctuation">;</span>   
<span class="token keyword">end</span>
get_results <span class="token operator">=</span> <span class="token function">struct2table</span><span class="token punctuation">(</span>get_results<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token function">feof</span><span class="token punctuation">(</span>fid<span class="token punctuation">)</span> <span class="token operator">~=</span> <span class="token number">1</span>
    file <span class="token operator">=</span>  <span class="token function">fgetl</span><span class="token punctuation">(</span>fpn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>

<span class="token function">fclose</span><span class="token punctuation">(</span>fid<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​        运行<strong>FPPI_miss_rate.m</strong>，里面含有matlab内置函数生成图像。</p>
<pre class="line-numbers language-matlab"><code class="language-matlab"><span class="token punctuation">[</span>am<span class="token punctuation">,</span>fppi<span class="token punctuation">,</span>missRate<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">evaluateDetectionMissRate</span><span class="token punctuation">(</span>get_scr_bbox<span class="token punctuation">,</span><span class="token function">get_results</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">% Plot log average miss rate - FPPI.</span>
figure
<span class="token function">loglog</span><span class="token punctuation">(</span>fppi<span class="token punctuation">,</span> missRate<span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">,</span><span class="token string">'linewidth'</span><span class="token punctuation">,</span><span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">%还有线条类型可以选择</span>
<span class="token function">xlabel</span><span class="token punctuation">(</span><span class="token string">'false positives per image'</span><span class="token punctuation">)</span>
<span class="token function">ylabel</span><span class="token punctuation">(</span><span class="token string">'miss rate'</span><span class="token punctuation">)</span>
grid on
<span class="token function">set</span><span class="token punctuation">(</span>gca<span class="token punctuation">,</span> <span class="token string">'yMinorTick'</span><span class="token punctuation">,</span><span class="token string">'on'</span><span class="token punctuation">)</span>
<span class="token function">set</span><span class="token punctuation">(</span>gca<span class="token punctuation">,</span> <span class="token string">'xMinorTick'</span><span class="token punctuation">,</span> <span class="token string">'on'</span><span class="token punctuation">)</span>
hleg1 <span class="token operator">=</span> <span class="token function">legend</span><span class="token punctuation">(</span><span class="token string">'yolov3'</span><span class="token punctuation">)</span>
<span class="token function">set</span><span class="token punctuation">(</span>hleg1<span class="token punctuation">,</span> <span class="token string">'Location'</span><span class="token punctuation">,</span> <span class="token string">'NorthEast'</span><span class="token punctuation">)</span>
<span class="token function">title</span><span class="token punctuation">(</span><span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string">'log Average Miss Rate = %.5f'</span><span class="token punctuation">,</span>am<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​        最终图像</p>
<img width="600" src="https://i.loli.net/2020/11/09/w9SqibYszcngXd3.png">

<h3 id="5-补充"><a href="#5-补充" class="headerlink" title="5.补充"></a>5.补充</h3><p>1.在results下生成的预测结果文件person.txt，坐标信息<strong>分别是左上角xy坐标和右下角xy坐标且是真实坐标。</strong></p>
<p>2.绘制fppi/miss rate图中detectionResults中的Boxes，坐标信息<strong>左上角xy、w、h且是真实值</strong>。</p>
<p>3.用voc_label.py生成的labels文件夹里的坐标信息是<strong>左上角xy、w、h但归一化后的值。</strong></p>
<p>4.生成的person_gt.txt和person_gt_matlab.txt都是<strong>左上角xy，wh真实值</strong>。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.sunmengxin.cn" rel="external nofollow noreferrer">YanBin</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.sunmengxin.cn/fengyanbin/yolo3-caltech/">https://www.sunmengxin.cn/fengyanbin/yolo3-caltech/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://www.sunmengxin.cn" target="_blank">YanBin</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E8%A7%86%E8%A7%89/">
                                    <span class="chip bg-color">视觉</span>
                                </a>
                            
                                <a href="/tags/Yolov3/">
                                    <span class="chip bg-color">Yolov3</span>
                                </a>
                            
                                <a href="/tags/Caltech/">
                                    <span class="chip bg-color">Caltech</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'a11a3096036e779926db',
        clientSecret: 'da4b0561b9167b08372307d20f6819677ce55b32',
        repo: 'MM-X.github.io',
        owner: 'MM-X',
        admin: "MM-X",
        id: '2020-11-09T14-00-00',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'GYwtSGt9IbspWTNY7fXrjSOJ-MdYXbMMI',
        appKey: 'OzqXKDXIf5fBFSseriGcBU0O',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '没有Github账号在这里填上昵称即可评论！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/fengyanbin/yolo3-caltech/">
                    <div class="card-image">
                        
                        <img src="https://i.loli.net/2020/11/09/WL4aG6UAZIKwDd5.png" class="responsive-img" alt="全网最详细Yolov3训练Caltech Pedestrain数据集并绘制fppi miss rate图">
                        
                        <span class="card-title">全网最详细Yolov3训练Caltech Pedestrain数据集并绘制fppi miss rate图</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Yolov3训练Caltech Pedestrain数据集
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-11-09
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%A7%86%E8%A7%89/" class="post-category">
                                    视觉
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%A7%86%E8%A7%89/">
                        <span class="chip bg-color">视觉</span>
                    </a>
                    
                    <a href="/tags/Yolov3/">
                        <span class="chip bg-color">Yolov3</span>
                    </a>
                    
                    <a href="/tags/Caltech/">
                        <span class="chip bg-color">Caltech</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/CSCC/08-structure-function/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="计算机组成原理 - 8.CPU的结构与功能">
                        
                        <span class="card-title">计算机组成原理 - 8.CPU的结构与功能</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            《计算机组成原理》总结第八章
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-03-16
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/" class="post-category">
                                    计算机组成原理
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%8E%9F%E5%88%9B/">
                        <span class="chip bg-color">原创</span>
                    </a>
                    
                    <a href="/tags/%E7%A1%AC%E4%BB%B6/">
                        <span class="chip bg-color">硬件</span>
                    </a>
                    
                    <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/">
                        <span class="chip bg-color">计算机组成原理</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: MengXin<br />'
            + '文章作者: MengXin<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

    
<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 2020 MengXin. All Rights Reserved.

            <br>
            <span id="sitetime"></span>

            

            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'></span>
                &nbsp;<i class="fa fa-heart-o"></i>&nbsp;
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>

            

            
            <span id="busuanzi_container_site_uv" style='display:none'></span>
                人次,&nbsp;访客人数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.

            
            

            
                &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
                <span class="white-color">35k</span>
                

        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/MM-X" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
    <i class="fab fa-github"></i>
    </a>



    <a href="mailto:599590980@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=599590980" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 599590980" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 0;
        var uvcountOffset = 0;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2019, 12, 18, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '');
</script>


    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

    <!-- 雪花特效 -->
    

        <!-- 天气接口控件  2019.09.09 -->
    
      <!-- weather -->
<script type="text/javascript">
WIDGET = {FID: 'yaeB7vnmth'}
</script>
<!-- <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script> -->

<script type="text/javascript">
  //只在桌面版网页启用特效
  var windowWidth = $(window).width();
  if (windowWidth > 768) {
      document.write('<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"><\/script>');
  }
  </script>

    


       <script type="text/javascript"> var OriginTitile = document.title, st;
    document.addEventListener("visibilitychange", function () { document.hidden ?
    (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) :
    (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () {
    document.title = OriginTitile }, 3e3)) })
       </script>

</body>

</html>
